<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>繪本說書人 - 語言與想像力遊戲</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@500;700&family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #FDFBF7;
            user-select: none;
            overflow-x: hidden;
        }
        .font-serif { font-family: 'Noto Serif TC', serif; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        /* 拖移樣式修正：強制不殘留半透明 */
        .is-dragging {
            opacity: 0.2 !important;
            cursor: grabbing !important;
        }
        
        .card-shadow {
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05), 0 8px 10px -6px rgba(0, 0, 0, 0.05);
        }
        
        .card-item {
            transition: transform 0.25s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        
        .text-mode-bg {
            background: linear-gradient(135deg, #fffcf9 0%, #fff7ed 100%);
        }

        .cursor-grab { cursor: grab; }
        .cursor-grabbing { cursor: grabbing; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useRef } = React;

        // --- 經五度校對的高精準圖庫 (PID 經嚴格過濾，確保單一主體) ---
        const IMAGE_LIBRARY = {
            daily: [
                { id: 'd1', pid: '1568901346375-23c9450c58cd', name: '漢堡' },
                { id: 'd2', pid: '1523275335684-37898b6baf30', name: '手錶' },
                { id: 'd3', pid: '1509440159596-0249088772ff', name: '法國麵包' },
                { id: 'd4', pid: '1584622650111-993a426fbf0a', name: '捲好的毛巾' },
                { id: 'd5', pid: '1516035069371-29a1b244cc32', name: '照相機' },
                { id: 'd6', pid: '1505740420928-5e560c06d30e', name: '耳機' },
                { id: 'd7', pid: '1525966222134-fcfa99b8ae77', name: '運動鞋' },
                { id: 'd8', pid: '1526170315870-ef6872999916', name: '拍立得' },
                { id: 'd9', pid: '1489274591220-1b2027e7d953', name: '衣架' },
                { id: 'd10', pid: '1542272604-787c3835535d', name: '牛仔褲' },
                { id: 'd11', pid: '1572635196237-14b3f281503f', name: '太陽眼鏡' },
                { id: 'd12', pid: '1491553895911-0055eca6402d', name: '白色帆布鞋' },
                { id: 'd13', pid: '1549050818483-347065c71650', name: '耳罩' },
                { id: 'd14', pid: '1525904097878-94fb15835963', name: '盆栽仙人掌' },
                { id: 'd15', pid: '1536766763667-5b675102916c', name: '咖啡杯' },
                { id: 'd16', pid: '1511499767010-a5883fd9a2c2', name: '眼鏡' },
                { id: 'd17', pid: '1553062407-98eeb64c6a62', name: '後背包' },
                { id: 'd18', pid: '1516641399197-6034c5615794', name: '牙刷' },
                { id: 'd19', pid: '1495474472287-4d71bcdd2085', name: '咖啡豆' },
                { id: 'd20', pid: '1585514162491-499368d42398', name: '手壓壺' },
                { id: 'd21', pid: '1517610822542-c9a2e9259cd0', name: '草帽' },
                { id: 'd22', pid: '1581539250439-c9462a4d53dd', name: '木頭椅子' },
                { id: 'd23', pid: '1560518141-94f71b27656d', name: '靠枕' },
                { id: 'd24', pid: '1507473885765-e6ed657db346', name: '檯燈' },
                { id: 'd25', pid: '1600857544200-b2b666293444', name: '肥皂' },
                { id: 'd26', pid: '1541653224-0683b1236d63', name: '香水瓶' },
                { id: 'd27', pid: '1563245372-f21724e3856d', name: '叉子' },
                { id: 'd28', pid: '1511556820241-470417bb6599', name: '收音機' },
                { id: 'd29', pid: '1592169910633-4d003a27045b', name: '皮帶' },
                { id: 'd30', pid: '1580915411954-282cb1b0d780', name: '洗手液' }
            ],
            animal: [
                { id: 'a1', pid: '1514888286974-6c03e2ca1dba', name: '橘貓' },
                { id: 'a2', pid: '1537151608828-ea2b11777ee8', name: '黃金獵犬' },
                { id: 'a3', pid: '1585110396000-c9ffd4e4b308', name: '白兔' },
                { id: 'a4', pid: '1546182990-dffeafbe841d', name: '獅子' },
                { id: 'a5', pid: '1484557985045-edf25e08da73', name: '小羊' },
                { id: 'a6', pid: '1555169062-013468b47731', name: '金剛鸚鵡' },
                { id: 'a7', pid: '1526336024174-e58f5cdd8e13', name: '蝴蝶' },
                { id: 'a8', pid: '1534361960057-19889db9621e', name: '柯基犬' },
                { id: 'a9', pid: '1501705388883-4ed8a543392c', name: '企鵝' },
                { id: 'a10', pid: '1510853675132-58241c941e4f', name: '狐狸' }, // 確保狐狸 PID 正確
                { id: 'a11', pid: '1474511320723-9a56873867b5', name: '松鼠' },
                { id: 'a12', pid: '1557050541571-518f155e8120', name: '大象' }, // 確保大象 PID 正確
                { id: 'a13', pid: '1529669851596-ba9a5549af95', name: '袋鼠' },
                { id: 'a14', pid: '1437622368342-7a3d73a34c8f', name: '海龜' },
                { id: 'a15', pid: '1502082553048-f009c37129b9', name: '麋鹿' },
                { id: 'a16', pid: '1564349683136-77e08bef1ed1', name: '貓熊' },
                { id: 'a17', pid: '1444464666168-49d633b867ad', name: '藍鳥' },
                { id: 'a18', pid: '1507666405495-423fef0046fd', name: '長頸鹿' },
                { id: 'a19', pid: '1516750484197-6b28d10c91ea', name: '斑馬' },
                { id: 'a20', pid: '1456926631375-92c8ce872def', name: '獵豹' },
                { id: 'a21', pid: '1425082661705-1834bfd09dca', name: '倉鼠' },
                { id: 'a22', pid: '1543946207-39bd91e70ca7', name: '猴子' },
                { id: 'a23', pid: '1503777119540-ce54b422baff', name: '老虎' },
                { id: 'a24', pid: '1535241749837-272deae75305', name: '小豬' },
                { id: 'a25', pid: '1497206365907-f5e630693df0', name: '火烈鳥' },
                { id: 'a26', pid: '1518791841217-8f162f1e1131', name: '黑貓' },
                { id: 'a27', pid: '1511216335773-ae10bd4196ad', name: '金魚' },
                { id: 'a28', pid: '1520638306518-af6058c49319', name: '無尾熊' },
                { id: 'a29', pid: '1553284965-0ef7c8591290', name: '公雞' },
                { id: 'a30', pid: '1493406300554-954df6397ca0', name: '小馬' }
            ],
            workplace: [
                { id: 'w1', pid: '1496181133206-80ce9b88a853', name: '筆記型電腦' },
                { id: 'w2', pid: '1541167760496-162955ed8a9f', name: '咖啡杯' },
                { id: 'w3', pid: '1506784365847-bbad939e9335', name: '桌曆' },
                { id: 'w4', pid: '1517842645767-c639042777db', name: '記事本' },
                { id: 'w5', pid: '1510127034890-ba27508e9f1c', name: '手提包' },
                { id: 'w6', pid: '1497032628192-86f99bcd76bc', name: '滑鼠' },
                { id: 'w7', pid: '1542744094-24638eff58bb', name: '鍵盤' },
                { id: 'w8', pid: '1586281380349-632531db7ed4', name: '計算機' },
                { id: 'w9', pid: '1589365278144-c9e705f843ba', name: '藍色文件夾' },
                { id: 'w10', pid: '1512314889357-e157c22f938d', name: '彩色便利貼' },
                { id: 'w11', pid: '1583484963886-cfe2bef37d7b', name: '鋼筆' },
                { id: 'w12', pid: '1516321318423-f06f85e504b3', name: '事務印表機' },
                { id: 'w13', pid: '1581091226825-a6a2a5aee158', name: '手機' },
                { id: 'w14', pid: '1522071823991-b19c72f740ff', name: '識別證' },
                { id: 'w15', pid: '1513364776144-60967b0f800f', name: '釘書機' },
                { id: 'w16', pid: '1506774050909-b2f88b8b82c1', name: '地球儀' },
                { id: 'w17', pid: '1581091226033-d5c48150dbaa', name: '獎盃' },
                { id: 'w18', pid: '1517433367423-c7e5b0f35086', name: '電腦主機' },
                { id: 'w19', pid: '1584438784894-089d6a62b839', name: '盆栽' },
                { id: 'w20', pid: '1512418490979-92798ccc13b0', name: '黑框眼鏡' },
                { id: 'w21', pid: '1486316145741-696730430073', name: '白板筆' },
                { id: 'w22', pid: '1554415707-c831f320b923', name: '削鉛筆機' },
                { id: 'w23', pid: '1488193138495-99228fd53229', name: '迴紋針' },
                { id: 'w24', pid: '1532074534361-ec036f077435', name: '公司印章' },
                { id: 'w25', pid: '1517048676734-d051473d93aa', name: '一壺熱茶' },
                { id: 'w26', pid: '1533090161728-4a47b1711653', name: '辦公桌' },
                { id: 'w27', pid: '1454160835308-562a2ad23969', name: '檯燈' },
                { id: 'w28', pid: '1551033042-26255315176c', name: '彩色鉛筆' },
                { id: 'w29', pid: '1515378804294-9a57002327b7', name: '電腦螢幕' },
                { id: 'w30', pid: '1517245386807-bbad939e9335', name: '白板' }
            ]
        };

        const THEMES = [
            { id: 'daily', name: '生活日常' },
            { id: 'animal', name: '森林動物' },
            { id: 'workplace', name: '職場生活' },
            { id: 'mixed', name: '綜合混合' }
        ];

        const MODES = [
            { id: 'image', name: '僅有圖片' },
            { id: 'text', name: '僅有文字' },
            { id: 'both', name: '圖文皆有' }
        ];

        const Icon = ({ name, size = 24, className = "" }) => {
            const icons = {
                settings: (
                    <>
                        <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/>
                        <circle cx="12" cy="12" r="3"/>
                    </>
                ),
                book: <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/>,
                refresh: (
                    <>
                        <path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"/>
                        <polyline points="21 3 21 8 16 8"/>
                    </>
                ),
                move: (
                    <>
                        <polyline points="5 9 2 12 5 15"/><polyline points="9 5 12 2 15 5"/>
                        <polyline points="15 19 12 22 9 19"/><polyline points="19 15 22 12 19 9"/>
                    </>
                ),
                next: (
                    <>
                        <polyline points="13 17 18 12 13 7"/><polyline points="6 17 11 12 6 7"/>
                    </>
                ),
                send: (
                    <>
                        <line x1="22" y1="2" x2="11" y2="13"/>
                        <polygon points="22 2 15 22 11 13 2 9 22 2"/>
                    </>
                )
            };
            return (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    {icons[name]}
                </svg>
            );
        };

        const App = () => {
            const [gameState, setGameState] = useState('setup'); 
            const [imageCount, setImageCount] = useState(4);
            const [selectedTheme, setSelectedTheme] = useState(THEMES[0]);
            const [displayMode, setDisplayMode] = useState('both');
            const [images, setImages] = useState([]);
            const [usedPidsHistory, setUsedPidsHistory] = useState(new Set()); 
            const [story, setStory] = useState('');
            const [draggedIdx, setDraggedIdx] = useState(null);

            const getPool = () => {
                if (selectedTheme.id === 'mixed') {
                    return [...IMAGE_LIBRARY.daily, ...IMAGE_LIBRARY.animal, ...IMAGE_LIBRARY.workplace];
                }
                return IMAGE_LIBRARY[selectedTheme.id];
            };

            const shuffle = (array) => {
                const newArr = [...array];
                for (let i = newArr.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [newArr[i], newArr[j]] = [newArr[j], newArr[i]];
                }
                return newArr;
            };

            const startGame = () => {
                const pool = getPool();
                let available = pool.filter(img => !usedPidsHistory.has(img.pid));
                let currentHistory = new Set(usedPidsHistory);
                
                if (available.length < imageCount) {
                    currentHistory = new Set();
                    available = [...pool];
                }

                const shuffled = shuffle(available);
                const selection = [];
                const seenThisRound = new Set();

                for (const img of shuffled) {
                    if (!seenThisRound.has(img.pid)) {
                        selection.push(img);
                        seenThisRound.add(img.pid);
                        currentHistory.add(img.pid);
                    }
                    if (selection.length === imageCount) break;
                }
                
                setImages(selection);
                setUsedPidsHistory(currentHistory);
                setGameState('playing');
                setStory('');
            };

            const nextQuestion = () => {
                startGame();
            };

            const handleImageError = (failedPid, currentIdx) => {
                if (displayMode === 'text') return;
                const pool = getPool();
                const currentDisplayedPids = new Set(images.map(img => img.pid));
                let backupPool = pool.filter(img => 
                    !currentDisplayedPids.has(img.pid) && 
                    !usedPidsHistory.has(img.pid) && 
                    img.pid !== failedPid
                );
                
                if (backupPool.length === 0) {
                    backupPool = pool.filter(img => !currentDisplayedPids.has(img.pid));
                }

                const backup = backupPool[Math.floor(Math.random() * backupPool.length)];
                
                if (backup) {
                    setImages(prev => {
                        const next = [...prev];
                        next[currentIdx] = backup;
                        return next;
                    });
                }
            };

            // --- 強制清理拖動狀態 ---
            const onDragStart = (e, index) => {
                setDraggedIdx(index);
                e.dataTransfer.effectAllowed = "move";
                // 使用一個全透明的點作為拖動圖像，防止原圖跳動
                const img = new Image();
                img.src = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7';
                e.dataTransfer.setDragImage(img, 0, 0);
            };

            const onDragOver = (e, index) => {
                e.preventDefault();
                if (draggedIdx === null || draggedIdx === index) return;
                
                const newImages = [...images];
                const draggedItem = newImages[draggedIdx];
                newImages.splice(draggedIdx, 1);
                newImages.splice(index, 0, draggedItem);
                
                setImages(newImages);
                setDraggedIdx(index);
            };

            const onDragEnd = (e) => {
                setDraggedIdx(null);
            };

            // 全域清理機制
            useEffect(() => {
                const cleanup = () => setDraggedIdx(null);
                window.addEventListener('mouseup', cleanup);
                window.addEventListener('dragend', cleanup);
                return () => {
                    window.removeEventListener('mouseup', cleanup);
                    window.removeEventListener('dragend', cleanup);
                };
            }, []);

            const getGridCols = () => {
                if (imageCount <= 4) return "grid-cols-2 sm:grid-cols-4";
                if (imageCount <= 6) return "grid-cols-2 sm:grid-cols-3 md:grid-cols-6";
                return "grid-cols-2 sm:grid-cols-4 md:grid-cols-8";
            };

            return (
                <div className="min-h-screen p-4 md:p-8 max-w-7xl mx-auto" onDragOver={(e) => e.preventDefault()}>
                    <header className="flex flex-col sm:flex-row items-center justify-between mb-8 gap-4">
                        <div className="flex items-center gap-3">
                            <div className="p-3 bg-orange-500 rounded-2xl text-white shadow-lg">
                                <Icon name="book" size={28} />
                            </div>
                            <div>
                                <h1 className="text-2xl font-black text-slate-800 tracking-tight text-center sm:text-left leading-tight">
                                    繪本說書人
                                </h1>
                                <div className="text-[10px] font-bold text-slate-400 uppercase tracking-[0.2em] mt-1">
                                    當前池進度: {usedPidsHistory.size} / {getPool().length}
                                </div>
                            </div>
                        </div>
                        {gameState !== 'setup' && (
                            <div className="flex items-center gap-3">
                                {gameState === 'playing' && (
                                    <button 
                                        onClick={nextQuestion} 
                                        className="px-4 py-2 bg-white border border-slate-200 rounded-full text-xs font-bold text-orange-500 hover:bg-orange-50 transition-all shadow-sm flex items-center gap-2 active:scale-95"
                                    >
                                        <Icon name="next" size={14} />
                                        <span>下一題</span>
                                    </button>
                                )}
                                <button onClick={() => setGameState('setup')} className="p-2.5 bg-white border border-slate-200 rounded-full text-slate-400 hover:text-orange-500 hover:border-orange-200 transition-all shadow-sm active:scale-95">
                                    <Icon name="refresh" size={20} />
                                </button>
                            </div>
                        )}
                    </header>

                    {gameState === 'setup' && (
                        <div className="max-w-xl mx-auto bg-white rounded-3xl shadow-xl border border-orange-100 p-8 animate-in fade-in zoom-in-95">
                            <h2 className="text-xl font-bold mb-8 flex items-center gap-2 text-orange-600">
                                <Icon name="settings" size={22} /> 冒險準備
                            </h2>
                            <div className="space-y-10">
                                <div>
                                    <div className="flex justify-between items-end mb-4">
                                        <label className="text-sm font-bold text-slate-700 uppercase tracking-widest">圖卡數量</label>
                                        <span className="text-2xl font-black text-orange-500">{imageCount} 張</span>
                                    </div>
                                    <input type="range" min="3" max="8" value={imageCount} onChange={(e) => setImageCount(parseInt(e.target.value))} className="w-full h-2 bg-slate-100 rounded-lg appearance-none cursor-pointer accent-orange-500" />
                                </div>
                                
                                <div>
                                    <label className="text-sm font-bold text-slate-700 uppercase tracking-widest block mb-4">主題類別</label>
                                    <div className="grid grid-cols-2 gap-3">
                                        {THEMES.map(t => (
                                            <button key={t.id} onClick={() => {
                                                setSelectedTheme(t);
                                                setUsedPidsHistory(new Set()); 
                                            }} className={`p-4 rounded-2xl border-2 transition-all font-bold ${selectedTheme.id === t.id ? 'border-orange-500 bg-orange-50 text-orange-700 ring-4 ring-orange-50' : 'border-slate-50 bg-slate-50 text-slate-500 hover:border-slate-200'}`}>
                                                {t.name}
                                            </button>
                                        ))}
                                    </div>
                                </div>

                                <div>
                                    <label className="text-sm font-bold text-slate-700 uppercase tracking-widest block mb-4">顯示模式</label>
                                    <div className="flex p-1 bg-slate-100 rounded-2xl gap-1">
                                        {MODES.map(m => (
                                            <button 
                                                key={m.id}
                                                onClick={() => setDisplayMode(m.id)}
                                                className={`flex-1 py-3 rounded-xl text-sm font-bold transition-all ${displayMode === m.id ? 'bg-white text-orange-600 shadow-sm' : 'text-slate-400 hover:text-slate-600'}`}
                                            >
                                                {m.name}
                                            </button>
                                        ))}
                                    </div>
                                </div>

                                <button onClick={startGame} className="w-full py-5 bg-orange-500 hover:bg-orange-600 text-white rounded-2xl font-bold text-lg shadow-lg shadow-orange-100 active:scale-95 transition-all text-center">
                                    開啟我的故事篇章
                                </button>
                            </div>
                        </div>
                    )}

                    {(gameState === 'playing' || gameState === 'finished') && (
                        <div className="space-y-10 animate-in fade-in">
                            <div className="flex flex-col items-center">
                                <div className={`grid ${getGridCols()} gap-4 w-full`}>
                                    {images.map((img, idx) => (
                                        <div 
                                            key={`${img.id}-${idx}`}
                                            draggable={gameState === 'playing'}
                                            onDragStart={(e) => onDragStart(e, idx)}
                                            onDragOver={(e) => onDragOver(e, idx)}
                                            onDragEnd={onDragEnd}
                                            className={`card-item relative flex flex-col ${draggedIdx === idx ? 'is-dragging' : ''}`}
                                        >
                                            <div className="bg-white p-2 pb-3 rounded-2xl card-shadow border border-slate-100 overflow-hidden cursor-grab active:cursor-grabbing h-full flex flex-col">
                                                <div className="aspect-square rounded-xl overflow-hidden bg-slate-50 relative flex-shrink-0 flex items-center justify-center">
                                                    {displayMode !== 'text' ? (
                                                        <img 
                                                            src={`https://images.unsplash.com/photo-${img.pid}?auto=format&fit=crop&q=80&w=400`} 
                                                            className="w-full h-full object-cover select-none pointer-events-none"
                                                            alt={img.name}
                                                            referrerPolicy="no-referrer"
                                                            onError={() => handleImageError(img.pid, idx)}
                                                        />
                                                    ) : (
                                                        <div className="w-full h-full text-mode-bg flex items-center justify-center p-4 pointer-events-none">
                                                            <span className="text-xl md:text-2xl font-black text-orange-800 text-center leading-tight">
                                                                {img.name}
                                                            </span>
                                                        </div>
                                                    )}
                                                </div>
                                                {displayMode === 'both' && (
                                                    <div className="mt-2 text-center text-[10px] font-black text-orange-600 bg-orange-50 py-1 rounded-lg">
                                                        {img.name}
                                                    </div>
                                                )}
                                                <div className="absolute top-1.5 left-1.5 w-7 h-7 bg-orange-500 text-white rounded-full flex items-center justify-center font-black text-xs shadow-md border-2 border-white z-20 pointer-events-none">
                                                    {idx + 1}
                                                </div>
                                                {gameState === 'playing' && (
                                                    <div className="absolute top-2 right-2 p-1 bg-white/60 backdrop-blur-md rounded-lg opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none text-slate-400">
                                                        <Icon name="move" size={12} />
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                                <p className="text-[10px] text-slate-300 font-bold uppercase tracking-[0.2em] mt-6">
                                    {gameState === 'playing' ? "按住卡片拖移以調整故事順序" : "圖片序列已固定"}
                                </p>
                            </div>

                            <div className="max-w-3xl mx-auto">
                                {gameState === 'playing' ? (
                                    <div className="bg-white rounded-3xl shadow-2xl p-6 md:p-8 border border-orange-50">
                                        <div className="flex items-center gap-2 mb-4 text-slate-400">
                                            <Icon name="book" size={18} />
                                            <span className="text-xs font-bold uppercase tracking-widest">編織故事內容</span>
                                        </div>
                                        <textarea 
                                            value={story} 
                                            onChange={(e) => setStory(e.target.value)} 
                                            placeholder="按照上面的圖案與編號，寫下你的故事。你可以隨時更換順序，編號會跟著動喔！" 
                                            className="w-full min-h-[300px] p-6 rounded-2xl bg-slate-50/50 border-2 border-transparent focus:border-orange-100 focus:bg-white focus:ring-0 resize-none text-lg text-slate-700 leading-relaxed transition-all" 
                                        />
                                        <div className="mt-6 flex flex-col sm:flex-row justify-between items-center gap-4">
                                            <div className="text-[10px] text-slate-300 font-bold uppercase tracking-widest text-center sm:text-left flex flex-wrap gap-2">
                                                順序：{images.map(i=>i.name).join(' → ')}
                                            </div>
                                            <div className="flex gap-3 w-full sm:w-auto">
                                                <button 
                                                    onClick={() => setGameState('finished')} 
                                                    disabled={story.length < 5} 
                                                    className="w-full sm:w-auto px-16 py-4 bg-orange-500 text-white rounded-2xl font-bold flex items-center justify-center gap-2 hover:bg-orange-600 transition-all shadow-lg shadow-orange-100 disabled:opacity-30 active:scale-95 text-center"
                                                >
                                                    <Icon name="send" className="inline-block mr-2" />
                                                    故事完成
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                ) : (
                                    <div className="bg-white rounded-3xl shadow-2xl p-8 md:p-12 animate-in slide-in-from-bottom-8 border border-orange-100 text-center">
                                        <div className="mb-10">
                                            <div className="inline-block px-4 py-1.5 bg-orange-50 text-orange-600 rounded-full text-[10px] font-black uppercase tracking-[0.2em] mb-4">
                                                Story Completed
                                            </div>
                                            <h2 className="text-3xl font-black text-slate-900 tracking-tight italic">
                                                說書任務達成
                                            </h2>
                                        </div>
                                        <div className="bg-orange-50/50 p-8 rounded-3xl border-l-4 border-orange-400 text-orange-800 italic mb-12 leading-relaxed text-lg shadow-sm text-left">
                                            「你的故事充滿了畫面感，文字讓這些圖片有了新的靈魂！」
                                        </div>
                                        <div className="text-slate-700 whitespace-pre-wrap leading-loose text-xl font-serif border-t border-slate-50 pt-12 mb-12 text-left">
                                            {story}
                                        </div>
                                        <button 
                                            onClick={() => setGameState('setup')} 
                                            className="w-full py-5 bg-slate-900 text-white rounded-2xl font-bold text-lg hover:bg-black transition-all shadow-xl"
                                        >
                                            開啟下一段說書冒險
                                        </button>
                                    </div>
                                )}
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
