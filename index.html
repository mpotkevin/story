<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>繪本說書人 - 語言與想像力遊戲</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@500;700&family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #FDFBF7;
            user-select: none;
        }
        .font-serif { font-family: 'Noto Serif TC', serif; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        .dragging {
            opacity: 0.2;
            transform: scale(0.9);
            z-index: 10;
        }
        
        .card-shadow {
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05), 0 8px 10px -6px rgba(0, 0, 0, 0.05);
        }
        
        .card-item {
            transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1), opacity 0.3s ease;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useRef } = React;

        // --- 嚴格校對：90張完全不重複 PID 的圖庫 ---
        const IMAGE_LIBRARY = {
            daily: [
                { id: 'd1', pid: '1568901346375-23c9450c58cd', name: '漢堡' },
                { id: 'd2', pid: '1523275335684-37898b6baf30', name: '手錶' },
                { id: 'd3', pid: '1509440159596-0249088772ff', name: '麵包' },
                { id: 'd4', pid: '1584622650111-993a426fbf0a', name: '毛巾' },
                { id: 'd5', pid: '1516035069371-29a1b244cc32', name: '相機' },
                { id: 'd6', pid: '1591337676887-a217a6970a8a', name: '耳機' },
                { id: 'd7', pid: '1525966222134-fcfa99b8ae77', name: '運動鞋' },
                { id: 'd8', pid: '1526170315870-ef6872999916', name: '拍立得' },
                { id: 'd9', pid: '1520004434532-6684162097ec', name: '衣架' },
                { id: 'd10', pid: '1542272604-787c3835535d', name: '牛仔褲' },
                { id: 'd11', pid: '1572635196237-14b3f281503f', name: '墨鏡' },
                { id: 'd12', pid: '1491553895911-0055eca6402d', name: '球鞋' },
                { id: 'd13', pid: '1505740420928-5e560c06d30e', name: '耳罩' },
                { id: 'd14', pid: '1525904097878-94fb15835963', name: '仙人掌' },
                { id: 'd15', pid: '1506417395049-d05047b9580b', name: '咖啡杯' },
                { id: 'd16', pid: '1511499767010-a5883fd9a2c2', name: '眼鏡' },
                { id: 'd17', pid: '1553062407-98eeb64c6a62', name: '背包' },
                { id: 'd18', pid: '1516641399197-6034c5615794', name: '牙刷' },
                { id: 'd19', pid: '1566206091559-03c5d8a97838', name: '咖啡豆' },
                { id: 'd20', pid: '1595246140625-573b715d11dc', name: '磨豆機' },
                { id: 'd21', pid: '1503342217505-b0a15ec3261c', name: '草帽' },
                { id: 'd22', pid: '1583847268964-b28dc8f51f92', name: '椅子' },
                { id: 'd23', pid: '1556228453-efd6c1ff04f6', name: '靠枕' },
                { id: 'd24', pid: '1586023492125-27b2c045efd7', name: '檯燈' },
                { id: 'd25', pid: '1534073828943-f801091bb18c', name: '手工皂' },
                { id: 'd26', pid: '1530124560676-4fbc912f77c7', name: '香水瓶' },
                { id: 'd27', pid: '1563245372-f21724e3856d', name: '叉子' },
                { id: 'd28', pid: '1511556820241-470417bb6599', name: '收音機' },
                { id: 'd29', pid: '1592169910633-4d003a27045b', name: '皮帶' },
                { id: 'd30', pid: '1580915411954-282cb1b0d780', name: '洗手乳' }
            ],
            animal: [
                { id: 'a1', pid: '1514888286974-6c03e2ca1dba', name: '小貓' },
                { id: 'a2', pid: '1537151608828-ea2b11777ee8', name: '黃金獵犬' },
                { id: 'a3', pid: '1585110396000-c9ffd4e4b308', name: '白兔' },
                { id: 'a4', pid: '1546182990-dffeafbe841d', name: '雄獅' },
                { id: 'a5', pid: '1484557985045-edf25e08da73', name: '小羊' },
                { id: 'a6', pid: '1555169062-013468b47731', name: '鸚鵡' },
                { id: 'a7', pid: '1526336024174-e58f5cdd8e13', name: '蝴蝶' },
                { id: 'a8', pid: '1534361960057-19889db9621e', name: '幼犬' },
                { id: 'a9', pid: '1501705388883-4ed8a543392c', name: '企鵝' },
                { id: 'a10', pid: '1557050543-4d5f4e07ef46', name: '小狐狸' },
                { id: 'a11', pid: '1474511320723-9a56873867b5', name: '松鼠' },
                { id: 'a12', pid: '1530595467537-0b5996c41f2d', name: '大象' },
                { id: 'a13', pid: '1529669851596-ba9a5549af95', name: '袋鼠' },
                { id: 'a14', pid: '1437622368342-7a3d73a34c8f', name: '海龜' },
                { id: 'a15', pid: '1502082553048-f009c37129b9', name: '麋鹿' },
                { id: 'a16', pid: '1564349683136-77e08bef1ed1', name: '熊貓' },
                { id: 'a17', pid: '1444464666168-49d633b867ad', name: '藍鳥' },
                { id: 'a18', pid: '1507666405495-423fef0046fd', name: '長頸鹿' },
                { id: 'a19', pid: '1516750484197-6b28d10c91ea', name: '斑馬' },
                { id: 'a20', pid: '1456926631375-92c8ce872def', name: '獵豹' },
                { id: 'a21', pid: '1425082661705-1834bfd09dca', name: '倉鼠' },
                { id: 'a22', pid: '1543946207-39bd91e70ca7', name: '猴子' },
                { id: 'a23', pid: '1503777119540-ce54b422baff', name: '老虎' },
                { id: 'a24', pid: '1535241749837-272deae75305', name: '粉紅豬' },
                { id: 'a25', pid: '1497206365907-f5e630693df0', name: '火烈鳥' },
                { id: 'a26', pid: '1518791841217-8f162f1e1131', name: '黑貓' },
                { id: 'a27', pid: '1511216335773-ae10bd4196ad', name: '金魚' },
                { id: 'a28', pid: '1520638306518-af6058c49319', name: '無尾腳印' },
                { id: 'a29', pid: '1553284965-0ef7c8591290', name: '公雞' },
                { id: 'a30', pid: '1493406300554-954df6397ca0', name: '小馬' }
            ],
            workplace: [
                { id: 'w1', pid: '1496181133206-80ce9b88a853', name: '銀色筆電' },
                { id: 'w2', pid: '1541167760496-162955ed8a9f', name: '外帶咖啡' },
                { id: 'w3', pid: '1506784365847-bbad939e9335', name: '桌曆' },
                { id: 'w4', pid: '1517842645767-c639042777db', name: '黃色筆記本' },
                { id: 'w5', pid: '1510127034890-ba27508e9f1c', name: '皮製提包' },
                { id: 'w6', pid: '1497032628192-86f99bcd76bc', name: '無線滑鼠' },
                { id: 'w7', pid: '1542744094-24638eff58bb', name: '機械鍵盤' },
                { id: 'w8', pid: '1586281380349-632531db7ed4', name: '計算機' },
                { id: 'w9', pid: '1589365278144-c9e705f843ba', name: '文件夾' },
                { id: 'w10', pid: '1512314889357-e157c22f938d', name: '彩色便利貼' },
                { id: 'w11', pid: '1583484963886-cfe2bef37d7b', name: '黑鋼筆' },
                { id: 'w12', pid: '1516321318423-f06f85e504b3', name: '印表機' },
                { id: 'w13', pid: '1581091226825-a6a2a5aee158', name: '手機' },
                { id: 'w14', pid: '1522071823991-b19c72f740ff', name: '工作證' },
                { id: 'w15', pid: '1513364776144-60967b0f800f', name: '釘書機' },
                { id: 'w16', pid: '1506774050909-b2f88b8b82c1', name: '地球儀' },
                { id: 'w17', pid: '1581091226033-d5c48150dbaa', name: '冠軍獎盃' },
                { id: 'w18', pid: '1517433367423-c7e5b0f35086', name: '伺服器機櫃' },
                { id: 'w19', pid: '1584438784894-089d6a62b839', name: '盆栽' },
                { id: 'w20', pid: '1512418490979-92798ccc13b0', name: '工作眼鏡' },
                { id: 'w21', pid: '1486316145741-696730430073', name: '白板筆' },
                { id: 'w22', pid: '1554415707-c831f320b923', name: '削筆機' },
                { id: 'w23', pid: '1488193138495-99228fd53229', name: '曲別針' },
                { id: 'w24', pid: '1493933984767-123485747a12', name: '打孔機' },
                { id: 'w25', pid: '1521791136064-7986c2959d92', name: '印章' },
                { id: 'w26', pid: '1517048676734-d051473d93aa', name: '茶包' },
                { id: 'w27', pid: '1523211234567-c12345678901', name: '辦公桌架' },
                { id: 'w28', pid: '1454160835308-562a2ad23969', name: '檯燈' },
                { id: 'w29', pid: '1551033042-26255315176c', name: '公事圓珠筆' },
                { id: 'w30', pid: '1515378804294-9a57002327b7', name: '電腦主機' }
            ]
        };

        const THEMES = [
            { id: 'daily', name: '生活日常' },
            { id: 'animal', name: '森林動物' },
            { id: 'workplace', name: '職場生活' },
            { id: 'mixed', name: '綜合混合' }
        ];

        const Icon = ({ name, size = 24, className = "" }) => {
            const icons = {
                settings: (
                    <>
                        <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/>
                        <circle cx="12" cy="12" r="3"/>
                    </>
                ),
                play: <polygon points="5 3 19 12 5 21 5 3"/>,
                book: <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/>,
                refresh: (
                    <>
                        <path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"/>
                        <polyline points="21 3 21 8 16 8"/>
                    </>
                ),
                send: (
                    <>
                        <line x1="22" y1="2" x2="11" y2="13"/>
                        <polygon points="22 2 15 22 11 13 2 9 22 2"/>
                    </>
                ),
                loader: <path d="M12 2v4m0 12v4M4.93 4.93l2.83 2.83m8.48 8.48l2.83 2.83M2 12h4m12 0h4M4.93 19.07l2.83-2.83m8.48-8.48l2.83-2.83"/>,
                move: (
                    <>
                        <polyline points="5 9 2 12 5 15"/><polyline points="9 5 12 2 15 5"/>
                        <polyline points="15 19 12 22 9 19"/><polyline points="19 15 22 12 19 9"/>
                    </>
                )
            };
            return (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    {icons[name]}
                </svg>
            );
        };

        const App = () => {
            const [userApiKey, setUserApiKey] = useState(localStorage.getItem('gemini_api_key') || "");
            const [gameState, setGameState] = useState('setup'); 
            const [imageCount, setImageCount] = useState(4);
            const [selectedTheme, setSelectedTheme] = useState(THEMES[0]);
            const [showLabels, setShowLabels] = useState(false);
            const [images, setImages] = useState([]);
            const [prevImagePids, setPrevImagePids] = useState(new Set()); 
            const [story, setStory] = useState('');
            const [isAnalyzing, setIsAnalyzing] = useState(false);
            const [aiFeedback, setAiFeedback] = useState(null);
            const [draggedIdx, setDraggedIdx] = useState(null);

            // 取得當前模式的圖片庫
            const getPool = () => {
                if (selectedTheme.id === 'mixed') {
                    return [...IMAGE_LIBRARY.daily, ...IMAGE_LIBRARY.animal, ...IMAGE_LIBRARY.workplace];
                }
                return IMAGE_LIBRARY[selectedTheme.id];
            };

            // Fisher-Yates 洗牌演算法
            const shuffle = (array) => {
                const newArr = [...array];
                for (let i = newArr.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [newArr[i], newArr[j]] = [newArr[j], newArr[i]];
                }
                return newArr;
            };

            const startGame = () => {
                const pool = getPool();
                
                // 強制過濾掉上一輪出現過的 PID
                let available = pool.filter(img => !prevImagePids.has(img.pid));
                
                // 如果可用數量不足（罕見情況），則使用整個池
                if (available.length < imageCount) {
                    available = pool;
                }

                const shuffled = shuffle(available);
                
                // 嚴格選擇：保證本輪內 PID 絕對唯一
                const uniqueSelection = [];
                const seenInThisRound = new Set();
                
                for (let img of shuffled) {
                    if (!seenInThisRound.has(img.pid)) {
                        uniqueSelection.push(img);
                        seenInThisRound.add(img.pid);
                    }
                    if (uniqueSelection.length === imageCount) break;
                }
                
                setImages(uniqueSelection);
                // 儲存本次 PID 以供下一輪排除
                setPrevImagePids(new Set(uniqueSelection.map(i => i.pid)));
                setGameState('playing');
                setStory('');
                setAiFeedback(null);
            };

            const handleImageError = (failedPid, currentIdx) => {
                const pool = getPool();
                const currentDisplayedPids = new Set(images.map(img => img.pid));
                
                const backup = pool.find(img => !currentDisplayedPids.has(img.pid) && img.pid !== failedPid);
                
                if (backup) {
                    setImages(prev => {
                        const next = [...prev];
                        next[currentIdx] = backup;
                        return next;
                    });
                }
            };

            const onDragStart = (e, index) => {
                setDraggedIdx(index);
                e.dataTransfer.effectAllowed = "move";
            };

            const onDragOver = (e, index) => {
                e.preventDefault();
                if (draggedIdx === null || draggedIdx === index) return;
                
                const newImages = [...images];
                const draggedItem = newImages[draggedIdx];
                newImages.splice(draggedIdx, 1);
                newImages.splice(index, 0, draggedItem);
                
                setImages(newImages);
                setDraggedIdx(index);
            };

            const onDragEnd = () => setDraggedIdx(null);

            const analyzeStory = async () => {
                if (!userApiKey) {
                    setAiFeedback({ 
                        title: "故事完稿", 
                        feedback: `太棒了！這是一個關於「${images.map(i=>i.name).join('、')}」的故事。你的創意成功串聯了所有靈感！` 
                    });
                    setGameState('finished');
                    return;
                }

                setIsAnalyzing(true);
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${userApiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: `玩家根據圖片物件 [${images.map(i=>i.name).join(',')}] 寫了一個故事。請取個優雅書名並給予一段溫暖講評：\n\n"${story}"` }] }],
                            generationConfig: { 
                                responseMimeType: "application/json", 
                                responseSchema: { 
                                    type: "OBJECT", 
                                    properties: { title: { type: "STRING" }, feedback: { type: "STRING" } } 
                                } 
                            }
                        })
                    });
                    const result = await response.json();
                    setAiFeedback(JSON.parse(result.candidates[0].content.parts[0].text));
                    setGameState('finished');
                } catch (e) {
                    setAiFeedback({ title: "奇妙之旅", feedback: "你編織了一個動人的故事，每個物件在你的筆下都栩栩如生！" });
                    setGameState('finished');
                }
                setIsAnalyzing(false);
            };

            const saveApiKey = (key) => {
                setUserApiKey(key);
                localStorage.setItem('gemini_api_key', key);
            };

            const getGridCols = () => {
                if (imageCount <= 4) return "grid-cols-2 sm:grid-cols-4";
                if (imageCount <= 6) return "grid-cols-2 sm:grid-cols-3 md:grid-cols-6";
                return "grid-cols-2 sm:grid-cols-4 md:grid-cols-8";
            };

            return (
                <div className="min-h-screen p-4 md:p-8 max-w-7xl mx-auto">
                    <header className="flex flex-col sm:flex-row items-center justify-between mb-8 gap-4">
                        <div className="flex items-center gap-3">
                            <div className="p-3 bg-orange-500 rounded-2xl text-white shadow-lg">
                                <Icon name="book" size={28} />
                            </div>
                            <h1 className="text-2xl font-black text-slate-800 tracking-tight">繪本說書人</h1>
                        </div>
                        <div className="flex items-center gap-3">
                            <div className="hidden md:flex items-center bg-white border border-slate-200 rounded-full px-3 py-1.5 text-xs shadow-sm">
                                <Icon name="settings" size={14} className="text-slate-400 mr-2" />
                                <input type="password" value={userApiKey} onChange={(e) => saveApiKey(e.target.value)} className="outline-none w-24 bg-transparent font-mono" placeholder="Gemini API Key" />
                            </div>
                            {gameState !== 'setup' && (
                                <button onClick={() => setGameState('setup')} className="p-2.5 bg-white border border-slate-200 rounded-full text-slate-400 hover:text-orange-500 hover:border-orange-200 transition-all shadow-sm">
                                    <Icon name="refresh" size={20} />
                                </button>
                            )}
                        </div>
                    </header>

                    {gameState === 'setup' && (
                        <div className="max-w-xl mx-auto bg-white rounded-3xl shadow-xl border border-orange-100 p-8 animate-in fade-in zoom-in-95">
                            <h2 className="text-xl font-bold mb-8 flex items-center gap-2 text-orange-600">
                                <Icon name="settings" size={22} /> 冒險準備
                            </h2>
                            <div className="space-y-10">
                                <div>
                                    <div className="flex justify-between items-end mb-4">
                                        <label className="text-sm font-bold text-slate-700 uppercase tracking-widest">挑選卡片數量</label>
                                        <span className="text-2xl font-black text-orange-500">{imageCount} 張</span>
                                    </div>
                                    <input type="range" min="3" max="8" value={imageCount} onChange={(e) => setImageCount(parseInt(e.target.value))} className="w-full h-2 bg-slate-100 rounded-lg appearance-none cursor-pointer accent-orange-500" />
                                </div>
                                
                                <div className="grid grid-cols-2 gap-3">
                                    {THEMES.map(t => (
                                        <button key={t.id} onClick={() => setSelectedTheme(t)} className={`p-4 rounded-2xl border-2 transition-all font-bold ${selectedTheme.id === t.id ? 'border-orange-500 bg-orange-50 text-orange-700 ring-4 ring-orange-50' : 'border-slate-50 bg-slate-50 text-slate-500 hover:border-slate-200'}`}>
                                            {t.name}
                                        </button>
                                    ))}
                                </div>
                                
                                <div className="flex items-center gap-3 p-4 bg-slate-50 rounded-2xl">
                                    <input 
                                        type="checkbox" 
                                        id="labels" 
                                        checked={showLabels} 
                                        onChange={(e) => setShowLabels(e.target.checked)}
                                        className="w-5 h-5 accent-orange-500 rounded"
                                    />
                                    <label htmlFor="labels" className="text-sm font-bold text-slate-600 cursor-pointer">
                                        顯示圖片輔助標籤 (幫助辨識內容)
                                    </label>
                                </div>

                                <button onClick={startGame} className="w-full py-5 bg-orange-500 hover:bg-orange-600 text-white rounded-2xl font-bold text-lg shadow-lg shadow-orange-100 active:scale-95 transition-all">
                                    開啟我的故事篇章
                                </button>
                            </div>
                        </div>
                    )}

                    {(gameState === 'playing' || gameState === 'finished') && (
                        <div className="space-y-10 animate-in fade-in">
                            <div className="flex flex-col items-center">
                                <div className={`grid ${getGridCols()} gap-4 w-full`}>
                                    {images.map((img, idx) => (
                                        <div 
                                            key={`${img.id}-${idx}`}
                                            draggable={gameState === 'playing'}
                                            onDragStart={(e) => onDragStart(e, idx)}
                                            onDragOver={(e) => onDragOver(e, idx)}
                                            onDragEnd={onDragEnd}
                                            className={`card-item relative flex flex-col ${draggedIdx === idx ? 'dragging' : ''}`}
                                        >
                                            <div className="bg-white p-2 pb-3 rounded-2xl card-shadow border border-slate-100 overflow-hidden cursor-grab active:cursor-grabbing h-full flex flex-col">
                                                <div className="aspect-square rounded-xl overflow-hidden bg-slate-50 relative flex-shrink-0">
                                                    <img 
                                                        src={`https://images.unsplash.com/photo-${img.pid}?auto=format&fit=crop&q=80&w=400`} 
                                                        className="w-full h-full object-cover select-none pointer-events-none"
                                                        alt={img.name}
                                                        referrerPolicy="no-referrer"
                                                        onError={() => handleImageError(img.pid, idx)}
                                                    />
                                                </div>
                                                {showLabels && (
                                                    <div className="mt-2 text-center text-[10px] font-black text-orange-600 bg-orange-50 py-1 rounded-lg">
                                                        {img.name}
                                                    </div>
                                                )}
                                                <div className="absolute top-1.5 left-1.5 w-7 h-7 bg-orange-500 text-white rounded-full flex items-center justify-center font-black text-xs shadow-md border-2 border-white z-20">
                                                    {idx + 1}
                                                </div>
                                                {gameState === 'playing' && (
                                                    <div className="absolute top-2 right-2 p-1 bg-white/60 backdrop-blur-md rounded-lg opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none text-slate-400">
                                                        <Icon name="move" size={12} />
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                                <p className="text-[10px] text-slate-300 font-bold uppercase tracking-[0.2em] mt-6">
                                    {gameState === 'playing' ? "Drag and drop cards to reorder story flow" : "Your visual masterpiece sequence"}
                                </p>
                            </div>

                            <div className="max-w-3xl mx-auto">
                                {gameState === 'playing' ? (
                                    <div className="bg-white rounded-3xl shadow-2xl p-6 md:p-8 border border-orange-50">
                                        <div className="flex items-center gap-2 mb-4 text-slate-400">
                                            <Icon name="book" size={18} />
                                            <span className="text-xs font-bold uppercase tracking-widest">編織故事內容</span>
                                        </div>
                                        <textarea 
                                            value={story} 
                                            onChange={(e) => setStory(e.target.value)} 
                                            placeholder="按照上面的圖卡順序，把這些物件編成一個完整的故事。你可以隨時拖動圖片來更換順序，編號會自動調整喔！" 
                                            className="w-full min-h-[350px] p-6 rounded-2xl bg-slate-50/50 border-2 border-transparent focus:border-orange-100 focus:bg-white focus:ring-0 resize-none text-lg text-slate-700 leading-relaxed transition-all" 
                                        />
                                        <div className="mt-6 flex flex-col sm:flex-row justify-between items-center gap-4">
                                            <div className="text-[10px] text-slate-300 font-bold uppercase tracking-widest text-center sm:text-left flex flex-wrap gap-2">
                                                目前順序：{images.map(i=>i.name).join(' → ')}
                                            </div>
                                            <button 
                                                onClick={analyzeStory} 
                                                disabled={story.length < 5 || isAnalyzing} 
                                                className="w-full sm:w-auto px-12 py-4 bg-orange-500 text-white rounded-2xl font-bold flex items-center justify-center gap-2 hover:bg-orange-600 transition-all shadow-lg shadow-orange-100 disabled:opacity-30"
                                            >
                                                {isAnalyzing ? <Icon name="loader" className="animate-spin" /> : <Icon name="send" />}
                                                故事完成
                                            </button>
                                        </div>
                                    </div>
                                ) : (
                                    <div className="bg-white rounded-3xl shadow-2xl p-8 md:p-12 animate-in slide-in-from-bottom-8 border border-orange-50">
                                        <div className="text-center mb-10">
                                            <div className="inline-block px-4 py-1.5 bg-orange-50 text-orange-600 rounded-full text-[10px] font-black uppercase tracking-[0.2em] mb-4">
                                                Story Masterpiece
                                            </div>
                                            <h2 className="text-3xl font-black text-slate-900 tracking-tight">《{aiFeedback?.title}》</h2>
                                        </div>
                                        <div className="bg-orange-50/50 p-8 rounded-3xl border-l-4 border-orange-400 text-orange-800 italic mb-12 leading-relaxed text-lg shadow-sm">
                                            「{aiFeedback?.feedback}」
                                        </div>
                                        <div className="text-slate-700 whitespace-pre-wrap leading-loose text-xl font-serif border-t border-slate-50 pt-12 mb-12">
                                            {story}
                                        </div>
                                        <button 
                                            onClick={() => setGameState('setup')} 
                                            className="w-full py-5 bg-slate-900 text-white rounded-2xl font-bold text-lg hover:bg-black transition-all shadow-xl"
                                        >
                                            開啟新的故事篇章
                                        </button>
                                    </div>
                                )}
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
